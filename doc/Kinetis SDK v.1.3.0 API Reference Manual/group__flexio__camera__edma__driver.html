<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>Kinetis SDK v.1.3 API Reference Manual: FlexIO_Camera_EDMA Peripheral Driver</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="fs_logo.gif"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Kinetis SDK v.1.3 API Reference Manual
   &#160;<span id="projectnumber">Rev. 0</span>
   </div>
   <div id="projectbrief">Freescale Semiconductor, Inc.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>API&#160;Reference</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('group__flexio__camera__edma__driver.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">FlexIO_Camera_EDMA Peripheral Driver<div class="ingroups"><a class="el" href="group__flexio__camera.html">FlexIO-simulated Camera(FlexIO_Camera)</a></div></div>  </div>
</div><!--header-->
<div class="contents">
<p>This section describes the programming interface of the FlexIO Camera with eDMA Peripheral driver.</p>
<h1><a class="anchor" id="FxIOCaEdmaPDMB"></a>
FlexIO Camera with eDMA Peripheral Driver description</h1>
<p>FlexIO Camera with eDMA provides a use case that shows how to map the image data from the camera's sensor matrix to the indicated memory area. In this module, a DMA channel inside the driver syncs the data from the camera to memory automatically in the background. The DMA channel is triggered after the FlexIO Camera's buffer is filled and updates the data for every trigger. In this instance, the the internal DMA and camera's data stream are not relevant to the application. The application reads the mapped image data as soon as possible with no blocking. Reading the memory corresponds to reading the camera's sensor matrix directly.</p>
<p>Note that, when using DMA to transfer data, because of the cache for memory, the data mist be consistent. This means that, when reading data from memory, the application must ensure that data from or to the memory device is not cached.</p>
<h1>Usage of FlexIO Camera with eDMA Peripheral Driver</h1>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;fsl_edma_driver.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;fsl_flexio_camera_edma_driver.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;fsl_flexio_driver.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">volatile</span> uint16_t u16CameraFrameBuffer[OV7670_FRAME_PIXELS];</div>
<div class="line"></div>
<div class="line"><span class="comment">//------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">// DMA0 channel for LCD configuration structure.</span></div>
<div class="line"><span class="comment">//  details This DMA channel ensure 16-bit (2 bytes) data transfers from the</span></div>
<div class="line"><span class="comment">//          camera frame buffer to Flexbus (LCD SSD1289), which means</span></div>
<div class="line"><span class="comment">//          4800 (major loop) x 16 x 16-bit data transfers (32 bytes minor loops).</span></div>
<div class="line"><span class="comment">//          These transfers ensure frame displaying. </span></div>
<div class="line"><span class="comment">//          Data is transferred based on the shifter 0 status flag</span></div>
<div class="line"><span class="comment">//          (all shifter full-filled by appropriate data).</span></div>
<div class="line"><span class="comment">//------------------------------------------------------------------------------</span></div>
<div class="line"><span class="preprocessor">#define eDMA_LCD_CONFIG                                                           \</span></div>
<div class="line"><span class="preprocessor">{                                                                                 \</span></div>
<div class="line"><span class="preprocessor">    .srcAddr            = (uint32_t)u16CameraFrameBuffer,                         \</span></div>
<div class="line"><span class="preprocessor">    .destAddr           = (uint32_t)FLEX_BASE_ADDRESS,                            \</span></div>
<div class="line"><span class="preprocessor">    .srcTransferSize    = kEDMATransferSize_2Bytes,                               \</span></div>
<div class="line"><span class="preprocessor">    .destTransferSize   = kEDMATransferSize_2Bytes,                               \</span></div>
<div class="line"><span class="preprocessor">    .srcOffset          = 2,                                                      \</span></div>
<div class="line"><span class="preprocessor">    .destOffset         = 0,                                                      \</span></div>
<div class="line"><span class="preprocessor">    .srcLastAddrAdjust  = -((sizeof(u16CameraFrameBuffer))),                      \</span></div>
<div class="line"><span class="preprocessor">    .destLastAddrAdjust = 0,                                                      \</span></div>
<div class="line"><span class="preprocessor">    .srcModulo          = kEDMAModuloDisable,                                     \</span></div>
<div class="line"><span class="preprocessor">    .destModulo         = kEDMAModuloDisable,                                     \</span></div>
<div class="line"><span class="preprocessor">    .minorLoopCount     = 32,                                                     \</span></div>
<div class="line"><span class="preprocessor">    .majorLoopCount     = ((sizeof(u16CameraFrameBuffer)&gt;&gt;5)),                    \</span></div>
<div class="line"><span class="preprocessor">}</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">// eDMA configuration structure</span></div>
<div class="line"><a class="code" href="group__edma__driver.html#structedma__state__t">edma_state_t</a>         edmaState;</div>
<div class="line"></div>
<div class="line"><span class="comment">// eDMA for LCD. </span></div>
<div class="line"><a class="code" href="group__edma__driver.html#structedma__chn__state__t">edma_chn_state_t</a>       lcdEdmaChnState;</div>
<div class="line"><a class="code" href="group__edma__hal.html#structedma__software__tcd__t">edma_software_tcd_t</a>    lcdEdmaChnStcd[2];</div>
<div class="line"><a class="code" href="group__edma__hal.html#structedma__transfer__config__t">edma_transfer_config_t</a> lcdEdmeConfigStruct = eDMA_LCD_CONFIG;</div>
<div class="line"></div>
<div class="line"><span class="keyword">volatile</span> flexio_camera_edma_handler_t gFlexioCameraHandlerStruct;</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> port_vsync_callback(uint32_t pin);</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    ov7670_status_t ov7670_status;</div>
<div class="line">    uint32_t ret;</div>
<div class="line"></div>
<div class="line">    flexio_user_config_t flexioUserConfig =</div>
<div class="line">    {</div>
<div class="line">        .useInt           = <span class="keyword">false</span>,</div>
<div class="line">        .onDozeEnable     = <span class="keyword">true</span>,</div>
<div class="line">        .onDebugEnable    = <span class="keyword">true</span>,</div>
<div class="line">        .fastAccessEnable = <span class="keyword">true</span></div>
<div class="line">    };</div>
<div class="line">    <a class="code" href="group__edma__driver.html#structedma__user__config__t">edma_user_config_t</a> edmaUserConfig =</div>
<div class="line">    {</div>
<div class="line">        .<a class="code" href="group__edma__driver.html#af6a9367e435cdcc1a239a7ccbd38aa13">chnArbitration</a> = <a class="code" href="group__edma__hal.html#gga1ae691e6c3e3af80d079f01dc4e0d9d9acb97728581b710ac5b456c4f52e4b9ad">kEDMAChnArbitrationRoundrobin</a>,</div>
<div class="line">        .notHaltOnError = <span class="keyword">false</span></div>
<div class="line">    };</div>
<div class="line">    flexio_camera_user_config_t UserFlexioCameraConfigStruct =</div>
<div class="line">    {</div>
<div class="line">        .flexioInstance  = 0U,</div>
<div class="line">        .datPinStartIdx  = 24U, <span class="comment">// fxio_pin 24-31 is used as data pin.</span></div>
<div class="line">        .pclkPinIdx      = 1U,  <span class="comment">// fxio_pin 1 is used as PCLK pin.</span></div>
<div class="line">        .hrefPinIdx      = 18U, <span class="comment">// flexio_pin 18 is used as HREF pin.</span></div>
<div class="line">        .shifterStartIdx = 0U,  <span class="comment">// Shifters 0-7 are used as data buffers.</span></div>
<div class="line">        .timerIdx        = 0U</div>
<div class="line">    };</div>
<div class="line">    camera_edma_user_config_t UserCameraEdmaConfigStruct =</div>
<div class="line">    {</div>
<div class="line">        .userEdmaChn    = APP_EDMA_CHN_FOR_CAMERA,</div>
<div class="line">        .userBufAddr    = (uint32_t)(u16CameraFrameBuffer),</div>
<div class="line">        .userBufLenByte = (uint32_t)(<span class="keyword">sizeof</span>(u16CameraFrameBuffer))</div>
<div class="line">    };</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Initialize the hardware.</span></div>
<div class="line">    <span class="comment">// ...</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">//-----------------------------------------------------------------------------</span></div>
<div class="line">    <span class="comment">// Initialize the LCD (SSD1289) and the CAMERA (OV7670)</span></div>
<div class="line">    <span class="comment">// ...</span></div>
<div class="line"></div>
<div class="line"><span class="comment">//-----------------------------------------------------------------------------</span></div>
<div class="line">    <span class="comment">// Configure the FlexIO and eDMA </span></div>
<div class="line">    FLEXIO_DRV_Init(0U, &amp;flexioUserConfig);</div>
<div class="line">    <a class="code" href="group__edma__driver.html#ga7deb54a7e997d79de1ed7c4e85290688">EDMA_DRV_Init</a>(&amp;edmaState, &amp;edmaUserConfig);</div>
<div class="line"></div>
<div class="line"><span class="comment">//-----------------------------------------------------------------------------</span></div>
<div class="line">    <span class="comment">// Configure the flexio_camera with eDMA.</span></div>
<div class="line">    ret = FLEXIO_Camera_DRV_InitEdmaRx(</div>
<div class="line">            (flexio_camera_edma_handler_t *)&amp;gFlexioCameraHandlerStruct,</div>
<div class="line">            &amp;UserFlexioCameraConfigStruct,</div>
<div class="line">            &amp;UserCameraEdmaConfigStruct );</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (ret != kStatus_FlexIO_Camera_Success)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">while</span> (1); <span class="comment">// The program would be dead here if error.</span></div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"><span class="comment">//-----------------------------------------------------------------------------</span></div>
<div class="line">    <span class="comment">// Configure the flexio_camera&#39;s sync trigger for the LCD eDMA. </span></div>
<div class="line">    FLEXIO_Camera_DRV_SetBufferTriggerForExtEdma(</div>
<div class="line">                (flexio_camera_edma_handler_t *)&amp;gFlexioCameraHandlerStruct,</div>
<div class="line">                0x03, <span class="keyword">true</span>);</div>
<div class="line"></div>
<div class="line"><span class="comment">//-----------------------------------------------------------------------------</span></div>
<div class="line">    <span class="comment">// Configure the eDMA for LCD.</span></div>
<div class="line">    ret = <a class="code" href="group__edma__driver.html#ga447c2ba3ddc2f7539d9dcd643ee2cc6d">EDMA_DRV_RequestChannel</a>(</div>
<div class="line">                APP_EDMA_CHN_FOR_LCD, </div>
<div class="line">                (<a class="code" href="group__edma__request.html#gad052948ef0b5730afc6ce6101c34ae47">dma_request_source_t</a>)(kDmaRequestMux0Group1FlexIO0Channel0 + UserFlexioCameraConfigStruct.shifterStartIdx + 1U),</div>
<div class="line">                &amp;lcdEdmaChnState);</div>
<div class="line">    <span class="keywordflow">if</span> (ret == <a class="code" href="group__edma__driver.html#ggaf2953f24d4e77d2b48a81649b388e0c9a86bc626247a5202c28081d91d93fff07">kEDMAInvalidChannel</a>)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// The program crashes if the indicated channel is not available.</span></div>
<div class="line">        <span class="comment">// Try to use a different eDMA channel.</span></div>
<div class="line">        <span class="keywordflow">while</span> (1); </div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    ret = <a class="code" href="group__edma__driver.html#ga09a0300eac8bc8a616937b80cd98489e">EDMA_DRV_PrepareDescriptorTransfer</a>( </div>
<div class="line">                &amp;lcdEdmaChnState,</div>
<div class="line">                lcdEdmaChnStcd,</div>
<div class="line">                &amp;lcdEdmeConfigStruct,</div>
<div class="line">                <span class="keyword">false</span>, <span class="comment">// always disable eDMA transfer done interrupt.</span></div>
<div class="line">                <span class="keyword">false</span>  <span class="comment">// always disable auto shut down register when transfer is done.</span></div>
<div class="line">                );</div>
<div class="line">    <span class="keywordflow">if</span> (ret == <a class="code" href="group__edma__driver.html#ggaf2953f24d4e77d2b48a81649b388e0c9a86bc626247a5202c28081d91d93fff07">kEDMAInvalidChannel</a>)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">while</span> (1);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    ret = <a class="code" href="group__edma__driver.html#ga41390e32e4a85b91201830a84a5fcd60">EDMA_DRV_PushDescriptorToReg</a>( &amp;lcdEdmaChnState, lcdEdmaChnStcd);</div>
<div class="line">    <span class="keywordflow">if</span> (ret == <a class="code" href="group__edma__driver.html#ggaf2953f24d4e77d2b48a81649b388e0c9a86bc626247a5202c28081d91d93fff07">kEDMAInvalidChannel</a>)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">while</span> (1);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    ret = <a class="code" href="group__edma__driver.html#gae5dc17a0595a4e27b4877edea7549ece">EDMA_DRV_StartChannel</a>( &amp;lcdEdmaChnState );</div>
<div class="line">    <span class="keywordflow">if</span> (ret == <a class="code" href="group__edma__driver.html#ggaf2953f24d4e77d2b48a81649b388e0c9a86bc626247a5202c28081d91d93fff07">kEDMAInvalidChannel</a>)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">while</span> (1);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"><span class="comment">//-----------------------------------------------------------------------------</span></div>
<div class="line">    <span class="comment">// Finally, start the camera transfer</span></div>
<div class="line">    FLEXIO_Camera_DRV_StartEdmaRx(</div>
<div class="line">          (flexio_camera_edma_handler_t *)&amp;gFlexioCameraHandlerStruct);</div>
<div class="line"></div>
<div class="line">    FLEXIO_DRV_Start(0U);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Start the sync signal.</span></div>
<div class="line">    PORTA_InstallCallback(1, port_vsync_callback); <span class="comment">// vsync pin in PTA13 with priority value 1.</span></div>
<div class="line">    configure_app_gpio_pins(); <span class="comment">// Enable the interrupt of OV7670&#39;s vsync pins.</span></div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">while</span>(1) {}</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">//------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">// porta_callback function</span></div>
<div class="line"><span class="comment">// Function provided handling of porta IRQ. Rising edge interrupt.</span></div>
<div class="line"><span class="comment">// pin - pin mask </span></div>
<div class="line"><span class="comment">//------------------------------------------------------------------------------</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> port_vsync_callback(uint32_t pin)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (pin == (1&lt;&lt;13)) <span class="comment">// vsyhc pin.</span></div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// Reset eDMA for LCD.</span></div>
<div class="line">        <a class="code" href="group__edma__driver.html#ga41390e32e4a85b91201830a84a5fcd60">EDMA_DRV_PushDescriptorToReg</a>( &amp;lcdEdmaChnState, lcdEdmaChnStcd);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Reset eDMA for camera.</span></div>
<div class="line">        FLEXIO_Camera_DRV_ResetEdmaRx(</div>
<div class="line">              (flexio_camera_edma_handler_t *)&amp;gFlexioCameraHandlerStruct);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Reset the LCD.</span></div>
<div class="line">        <span class="comment">// ...</span></div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.5-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul class="foot">
    <li class="footer">Thu Sep 24 2015 &copy; 2015 Freescale Semiconductor, Inc. All rights reserved.
    </li>
  </ul>
</div>
</body>
</html>
